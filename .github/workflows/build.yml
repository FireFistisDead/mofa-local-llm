name: Build on Apple Silicon (macOS)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  # Allow manual trigger from the GitHub Actions tab
  workflow_dispatch:

jobs:
  build:
    name: Cargo Build (macOS Apple Silicon)
    runs-on: macos-latest   # GitHub's free M1/M2 Apple Silicon runner

    steps:
      # 1. Checkout mofa-local-llm
      - name: Checkout mofa-local-llm
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2. Checkout OminiX-MLX as a SUBDIRECTORY inside the workspace
      #    GitHub Actions only allows paths inside the workspace, so we put it
      #    at OminiX-MLX/ and patch Cargo.toml paths below.
      - name: Checkout OminiX-MLX
        uses: actions/checkout@v4
        with:
          repository: OminiX-ai/OminiX-MLX
          path: OminiX-MLX          # → $GITHUB_WORKSPACE/OminiX-MLX
          submodules: recursive

      # 3. Patch Cargo.toml: rewrite "../OminiX-MLX/" → "OminiX-MLX/"
      #    so Cargo resolves the local path crates correctly
      - name: Patch Cargo.toml paths
        run: |
          sed -i '' 's|path = "\.\./OminiX-MLX/|path = "OminiX-MLX/|g' Cargo.toml
          echo "=== Patched Cargo.toml dependencies ==="
          grep 'path = ' Cargo.toml

      # 4. Install Rust stable toolchain
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # 5. Cache Cargo registry + build artifacts to speed up repeat builds
      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # 6. Build the project (both binaries)
      - name: Build (debug)
        run: cargo build --verbose

      # 7. Run tests (if any)
      - name: Run tests
        run: cargo test --verbose

      # 8. Upload compiled binaries as downloadable artifacts
      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: mofa-binaries-macos
          path: |
            target/debug/mofa-server
            target/debug/mofa-gui
          retention-days: 7
